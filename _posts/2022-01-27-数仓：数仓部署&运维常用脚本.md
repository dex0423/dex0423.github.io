---
layout:     post
title:      数仓：数仓部署&运维常用工具和脚本
subtitle:   xsync
date:       2022-01-27
author:     dex0423
header-img: img/post-bg-os-metro.jpg
catalog: true
tags:
    - 数仓
---

# 1. xsync

##### 1.1. xsync 简介

改脚本基于 rsync 而写的，rsync 与 scp 的运行机制不一样，rsync 会对比集群内同目录下是否有不一致，如果有不一样的文件则同步文件过去，如果一致则不更新。

##### 1.2. xsync 脚本

- 在 bin 目录下创建 xsync；
  
    ```aidl
    cd /bin & vim xsync
    ```

- 编辑脚本；
  
    ```aidl
    #!/bin/sh
    
    # 获取输入参数个数，如果没有参数，直接退出
    pcount=$#
    if((pcount!=4)); then
        echo Usage: $0 filename servername startno endno
        exit;
    fi
    
    
    # 获取文件名称
    p1=$1
    fname=`basename $p1`
    echo fname=$fname
    
    # 获取上级目录到绝对路径
    pdir=`cd -P $(dirname $p1); pwd`
    echo pdir=$pdir
    # 获取当前用户名称
    user=`whoami`
    # 获取hostname及起止号
    slave=$2
    startline=$3
    endline=$4
    
    # 循环
    for((host=$startline; host<=$endline; host++)); do
        echo $pdir/$fname $user@$slave$host:$pdir
        echo ==================$slave$host==================
        rsync -rvl $pdir/$fname $user@$slave$host:$pdir
    done
    ```
- 修改权限

    ```aidl
    chmod 777 xsync
    ```

##### 1.3. xsync 使用

- 使用示例：

    ```aidl
    [root@hadoop-1 home]# sudo xsync 1.txt slave 1 2
    
    fname=1.txt
    pdir=/home
    /home/1.txt root@slave1:/home
    ==================slave1==================
    sending incremental file list
    1.txt
    
    sent 90 bytes  received 35 bytes  83.33 bytes/sec
    total size is 2  speedup is 0.02
    /home/1.txt root@slave2:/home
    ==================slave2==================
    sending incremental file list
    1.txt
    
    sent 90 bytes  received 35 bytes  250.00 bytes/sec
    total size is 2  speedup is 0.02
    ```

# 2. DataX

##### 2.1. DataX 安装部署

- 修改DB配置

  修改 datax 服务器本地数据库，用于存储 datax 账号密码、同步任务、数据源连接信息等；

  ```
  vim /home/work/datax-web/build/datax-web-2.1.2/modules/datax-admin/conf/bootstrap.properties

  #Database
  DB_HOST=xxx.xxx.xxx.xxx
  DB_PORT=3306
  DB_USERNAME=xxx
  DB_PASSWORD=xxx
  DB_DATABASE=dataxweb
  ```

- 安装 & 初始化

  ```
  cd /home/work/datax-web/build/datax-web-2.1.2/bin & ./install.sh

  ...
  Do you want to initalize database with sql: [/home/work/datax-web/build/datax-web-2.1.2/bin/db/datax_web.sql]? (Y/N)y
  Please input the db host(default: 127.0.0.1): 
  Please input the db port(default: 3306): 
  Please input the db username(default: root): xxxx
  Please input the db password(default: ): xxxx
  Please input the db name(default: dataxweb)
  ...
  ```


##### 2.2. DataX 启动命令

- 在启动前，记得先执行关闭操作；
  
    ```
    cd /home/work/datax-web/build/datax-web-2.1.2/bin
    bash stop-all.sh
    ./start-all.sh
    ```

##### 2.3. 访问 datax-web

- 访问地址：http://xxx.xxx.xxx.xxx:9527/index.html

- 访问datax-web 记住务必加/index.html，不加会提示 `Whitelabel Error Page` 报错！

##### 2.4. DataX 用户管理

- 注意：首次启动，一定要修改 admin 密码！

    修改路径： `用户管理 > admin > 编辑 > 密码`


##### 2.5. MySQL8 修改 jdbc 驱动类

- EDS 如果连接 MySQL8，数据源连接需要修改 jdbc 驱动类

  jdbc 驱动类：
    
    ```
    com.mysql.cj.jdbc.Driver
    ```

##### 2.6. DataX 异常处理

- 启动无报错，但无法访问 datax-web 网页

    - 处理方法：重新安装初始化 datax

        ```
        cd /home/work/datax-web/build/datax-web-2.1.2/bin & ./install.sh
        ```

- 重新安装初始化 datax 时无法连接 MySQL

    - 报错内容：

      `ERROR 1045 (28000): Access denied for user 'root'@'120.25.84.232' (using password: YES)`

    - 处理方法：不要使用 root 账号连接 MySQL，使用 jianzi 账号密码连接 MySQL

        ```
        Please input the db username(default: root): jianzi
        Please input the db password(default: ): 4ylnkL6lRT
        ```

- 启动 DataX 不成功：`not found in the java process table`

    - 报错内容：

      `DATAX-EXEXUTOR didn't start successfully, not found in the java process table`

    - 处理方法：
        ```
        ./start-all.sh start -v
        ```

- 无法连接数据源：`Could not create connection to database server`

    - 报错内容：
      
      `Code:[DBUtilErrorCode-10], Description:[连接数据库失败. 请检查您的 账号、密码、数据库名称、IP、Port或者向 DBA 寻求帮助(注意网络环境).]. - 具体错误信息为：com.mysql.jdbc.exceptions.jdbc4.MySQLNonTransientConnectionException: Could not create connection to database server.`
    
    - 处理方法：
    
        - 检查要连接的 MySQL 账号密码；
        - 检查要连接的 MySQL 服务器端口是否开放；
        - 检查要连接的 MySQL 版本，如果是 MySQL8，修改 jdbc 驱动类：
          ```
          com.mysql.cj.jdbc.Driver
          ```

- datax-web 创建任务时报错：`Unknown column 't.user_id' in 'field list' `

  - 报错内容：

    `### Error querying database. Cause: com.mysql.jdbc.exceptions.jdbc4.MySQLSyntaxErrorException: Unknown column 't.user_id' in 'field list' ### The error may exist in file [/home/work/datax-web/build/datax-web-2.1.2/modules/datax-admin/conf/mybatis-mapper/JobInfoMapper.xml] ### The error may involve com.wugui.datax.admin.mapper.JobInfoMapper.findAll-Inline ### The error occurred while setting parameters ### SQL: SELECT t.id, t.job_group, t.job_cron, t.job_desc, t.add_time, t.update_time, t.user_id, t.alarm_email, t.executor_route_strategy, t.executor_handler, t.executor_param, t.executor_block_strategy, t.executor_timeout, t.executor_fail_retry_count, t.glue_type, t.glue_source, t.glue_remark, t.glue_updatetime, t.child_jobid, t.trigger_status, t.trigger_last_time, t.trigger_next_time, t.job_json, t.replace_param, t.jvm_param, t.inc_start_time, t.partition_info, t.last_handle_code, t.replace_param_type, t.project_id, t.reader_table, t.primary_key, t.inc_start_id, t.increment_type, t.datasource_id FROM job_info AS t ORDER BY job_desc ASC ### Cause: com.mysql.jdbc.exceptions.jdbc4.MySQLSyntaxErrorException: Unknown column 't.user_id' in 'field list' ; bad SQL grammar []; nested exception is com.mysql.jdbc.exceptions.jdbc4.MySQLSyntaxErrorException: Unknown column 't.user_id' in 'field list'`

  - 处理方法：

    连接 dataX 服务器上 MySQL，进入 `dataxweb > jobinfo`，修改 `author(VARCHAR(50))` 字段名为 `user_id(INT(11))`；

    修改后重新创建任务；

    注意：这是个临时解决方案，详细原因并未知晓！！！
