---
layout:     post
title:      用户画像：标签模型开发设计
subtitle:   
date:       2022-01-01
author:     dex0423
header-img: img/post-bg-os-metro.jpg
catalog: true
tags:
    - 用户画像
---


# 标签模型

- 每个标签，一个应用程序，需要一个标签，就开发一 Spark 套程序，如果不再使用标签，则直接停止该程序；

- 标签开发
    - 标签开发，是用户画像工程化的重点模块，包含统计类、规则类、挖掘类、流式计算类标签的开发，以及人群计算功能的开发，打通画像数据和各业务系统之间的通路，提供接口服务等开发内容。
- 离线标签
    - 画像系统的标签，分为离线标签和实时标签。
    - 离线标签又分为基于统计类型的标签和基于算法性标签，大部分或者 90% 的标签都是统计类型标签；
    - 机器学习的算法标签很少：
        - 一方面是因为开发周期很长，
        - 另一方面效果也有限。
        - 但是基于某些场景，还是得需要使用机器学习，只是机器学习标签的比重会很小。
    - 有时我们做实时数据支持，会通过实时数据流给用户做刻画或者做特征标记，可做线上服务接口调用查询。
- 用户维表
    - 用户维表是一张大宽表，大宽表基于筛选用户的属性或分析师分析用户的时候用。除了标签跑批、用户维表，还有人群计算、行为数据等的数据开发。

- 标签表
    ```
    CREATE TABLE `tbl_basic_tag` (
      `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '标签ID',
      `name` varchar(50) DEFAULT NULL COMMENT '标签名称',
      `industry` varchar(30) DEFAULT NULL COMMENT '行业、子行业、业务类型、标签、属性',
      `rule` varchar(300) DEFAULT NULL COMMENT '标签规则',
      `business` varchar(100) DEFAULT NULL COMMENT '业务描述',
      `level` int(11) DEFAULT NULL COMMENT '标签等级',
      `pid` bigint(20) DEFAULT NULL COMMENT '父标签ID',
      `ctime` datetime DEFAULT NULL COMMENT '创建时间',
      `utime` datetime DEFAULT NULL COMMENT '修改时间',
      `state` int(11) DEFAULT NULL COMMENT '状态：1申请中、2开发中、3开发完成、4已上线、5已下线、6已禁用',
      `remark` varchar(100) DEFAULT NULL COMMENT '备注',
      PRIMARY KEY (`id`)
    ) ENGINE=InnoDB AUTO_INCREMENT=233 DEFAULT CHARSET=utf8 COMMENT='基础标签表';
    ```

- 模型表
    - 详细记录标签模型 application 的位置；
        ```
        CREATE TABLE `tbl_model` (
          `id` bigint(20) DEFAULT NULL,
          `tag_id` bigint(20) DEFAULT NULL COMMENT '标签ID',
          `type` int(11) DEFAULT NULL COMMENT '算法类型：统计-Statistics、规则匹配-Match、挖掘-具体算法-DecisionTree',
          `model_name` varchar(200) DEFAULT NULL COMMENT '模型名称',
          `model_main` varchar(200) DEFAULT NULL COMMENT '模型运行主类名称',
          `model_path` varchar(200) DEFAULT NULL COMMENT '模型JAR包HDFS路径',
          `sche_time` varchar(200) DEFAULT NULL COMMENT '模型调度时间',
          `ctime` datetime DEFAULT NULL COMMENT '创建模型时间戳',
          `utime` datetime DEFAULT NULL COMMENT '更新模型时间戳',
          `state` int(11) DEFAULT NULL COMMENT '模型状态，1：运行；0：停止',
          `remark` varchar(100) DEFAULT NULL,
          `operator` varchar(100) DEFAULT NULL,
          `operation` varchar(100) DEFAULT NULL,
          `args` varchar(100) DEFAULT NULL COMMENT '模型运行应用配置参数，如资源配置参数'
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8;
        ```

- 标签表上的每条记录，与模型表中的记录，是一一对应的。
    
  ![]({{site.baseurl}}/img-post/标签模型开发-1.png)

- spark 用户性别标签 模型示例：

    ```aidl
    package cn.itcast.model.models.match;
    
    import java.util.HashMap;
    import java.util.LinkedList;
    import java.util.List;
    import java.util.Map;
    import java.util.Properties;
    
    import cn.itcast.model.beans.BasicTagBean;
    import cn.itcast.model.beans.MetaDataBean;
    import cn.itcast.model.tools.hbase.HBaseTools;
    import org.apache.commons.lang.StringUtils;
    import org.apache.spark.SparkConf;
    import org.apache.spark.sql.Column;
    import org.apache.spark.sql.Dataset;
    import org.apache.spark.sql.Row;
    import org.apache.spark.sql.SparkSession;
    import org.apache.spark.sql.functions;
    import org.apache.spark.storage.StorageLevel;
    import org.slf4j.Logger;
    import org.slf4j.LoggerFactory;
    
    import com.google.common.base.Preconditions;
    import cn.itcast.model.models.AbstractModel;
    import cn.itcast.model.models.ModelConfig;
    import cn.itcast.model.tools.parser.MetaParser;
    import cn.itcast.model.tools.spark.sql.SQLHBase;
    
    /**
     * 用户性别标签模型
     * Created by mengyao
     * 2019年6月3日
     */
    public class Tag8Model extends AbstractModel {
    
        private Logger logger = LoggerFactory.getLogger(getClass());
        
        private static String appName = Tag8Model.class.getSimpleName();
        private ModelConfig modelConfig = new ModelConfig();
        private SparkConf sparkConf;
        private SparkSession session;
        private List<BasicTagBean> tag;
        
        
        public Tag8Model() {
            super(appName, "用户性别标签模型");
            sparkConf=new SparkConf()
                    .setAppName(appName)
                    .setMaster(modelConfig.getSparkMaster())
                    .registerKryoClasses(new Class[] {BasicTagBean.class});
            session = SQLHBase.getSession(sparkConf);
            logger.info("==== 已初始化SparkSQL相关配置 ====");
        }
        
        @Override
        public String getType() {
            return ModelType.MATCH.toString();
        }
        
        /**
         * 8  性别
         * 50 男=1
         * 51 女=2
         */
        @SuppressWarnings("serial")
        @Override
        public List<BasicTagBean> getTag() {
            if (null == tag) {
                // SQL按照level字段升序，确保第一条数据是4级标签
                Dataset<Row> rowDF = session.read().jdbc(
                        modelConfig.getMySQLUrl(),
                        "(SELECT `id`,`name`,`industry`,`rule`,`business`,`level`,`pid`,`ctime`,`utime`,`state`,`remark` FROM `tags`.`tbl_basic_tag` WHERE id = 8 UNION SELECT `id`,`name`,`industry`,`rule`,`business`,`level`,`pid`,`ctime`,`utime`,`state`,`remark` FROM `tags`.`tbl_basic_tag` WHERE pid = 8 ORDER BY `level` ASC) AS btag", 
                        new Properties() {{setProperty("driver", modelConfig.getMySQLDriver());}}
                        );
                List<Row> rows = rowDF.collectAsList();
                if (rows.size() > 0) {
                    tag = new LinkedList<BasicTagBean>();
                    rows.forEach(row -> {
                        BasicTagBean bean = new BasicTagBean();
                        if (!row.isNullAt(0)) {bean.setId(row.getLong(0));}
                        if (!row.isNullAt(1)) {bean.setName(row.getString(1));}
                        if (!row.isNullAt(2)) {bean.setIndustry(row.getString(2));}
                        if (!row.isNullAt(3)) {bean.setRule(row.getString(3));}
                        if (!row.isNullAt(4)) {bean.setBusiness(row.getString(4));}
                        if (!row.isNullAt(5)) {bean.setLevel(row.getInt(5));}
                        if (!row.isNullAt(6)) {bean.setPid(row.getLong(6));}
                        if (!row.isNullAt(7)) {bean.setCtime(row.getTimestamp(7).toString());}
                        if (!row.isNullAt(8)) {bean.setUtime(row.getTimestamp(8).toString());}
                        if (!row.isNullAt(9)) {bean.setState(row.getInt(9));}
                        if (!row.isNullAt(10)) {bean.setRemark(row.getString(10));}
                        tag.add(bean);
                    });
                    rowDF.unpersist();
                }			
            }
            logger.info("==== 模型所需的标签数据为: {} ====", tag);
            return tag;
        }
    
        @Override
        public void compute() {
            if (null == tag || tag.size() == 0) {
                logger.error("==== 没有该模型的标签数据！  ====");
                throw new RuntimeException();
            } else {
                // 四级标签规则必须存在
                String rule = tag.get(0).getRule();
                if (StringUtils.isEmpty(rule)) {
                    logger.error("==== 四级标签规则不存在！ ====");
                    throw new RuntimeException();
                } else {
                    MetaDataBean meta = MetaParser.getParser(rule).getMeta();
                    if (null == meta || StringUtils.isEmpty(meta.getInType())) {
                        logger.error("==== 标签规则解析失败！ ====");
                        throw new RuntimeException();
                    } else {
                        if (meta.getInType().toLowerCase().equals("hbase")) {
                            Map<String, String> options = null;
                            // 获取数据源表配置
                            String table = meta.getHbaseTable();
                            Preconditions.checkNotNull(table, "数据源表名必须不为空！");
                            String family = meta.getFamily();
                            Preconditions.checkNotNull(family, "数据源表的列簇必须不为空");
                            String selectFields = meta.getSelectFieldNames();
                            Preconditions.checkNotNull(selectFields, "数据源表的查询展示字段必须不为空！");
                            String whereFields = meta.getWhereFieldNames();
                            // 验证数据源的查询条件
                            if (StringUtils.isEmpty(whereFields)) {
                                //如果没有有查询条件
                                options = modelConfig.getOptions(table, family, selectFields);
                                logger.info("==== 数据源table={},family={},selectFileds={} ====", table, family, selectFields);
                            } else {
                                //如果有查询条件
                                options = modelConfig.getOptions(table, family, selectFields, whereFields);
                                logger.info("==== 数据源table={},family={},selectFileds={},whereFields={} ====", table, family, selectFields, whereFields);
                            }
                            // 获取画像表配置
                            String profileTable = modelConfig.getProfileTableName();
                            Preconditions.checkNotNull(profileTable, "画像表的表名必须不为空！");
                            String userFamily = modelConfig.getProfileTableFamilyUser();
                            Preconditions.checkNotNull(userFamily, "画像表的列簇必须不为空！");
                            String userFamilyAlias = modelConfig.getProfileTableFamilyUserAlias();
                            Preconditions.checkNotNull(userFamilyAlias, "画像表的RowKey前缀必须不为空！");
                            // qualifier=userId
                            String userIdColumn = modelConfig.getProfileFamilyUserCol();
                            Preconditions.checkNotNull(userIdColumn, "画像表的userId列必须不为空！");
                            // qualifier=tagIds
                            String tagIdsColumn = modelConfig.getProfileCommonCol();
                            Preconditions.checkNotNull(tagIdsColumn, "画像表的tagIds列必须不为空！");
                            // 获取HBase数据源插件实现
                            String format = modelConfig.getFormat();
                            Dataset<Row> rowDF = session.read()
                                    .format(format)
                                    .options(options)
                                    .load();
                            Dataset<Row> cacheDF = rowDF.persist(StorageLevel.DISK_ONLY());
                            // 五级 男标签
                            BasicTagBean manTag = tag.get(1);
                            long manId = manTag.getId();
                            String manGender = manTag.getRule();
                            // 五级 女标签
                            BasicTagBean womanTag = tag.get(2);
                            long womanId = womanTag.getId();
                            String womanGender = womanTag.getRule();
                            
                            Column genderColumn = new Column("gender");
                            //用户-关联五级标签,该DataFrame的Schema为userid,tagId
                            Dataset<Row> genderTagDF = cacheDF.select(new Column("id"), functions
                                    .when(genderColumn.equalTo(manGender), manId+"")//如果是男
                                    .when(genderColumn.equalTo(womanGender), womanId+"")//如果是女 //.otherwise(0)
                                    .alias("tagId"));
                            //logger.debug("==== 计算条数：{} ====", genderTagDF.count());
                            
                            HBaseTools build = HBaseTools.build();
                            //获取已存在的画像数据
                            Map<String, Map<String, String>> existProfileData = build.scan(profileTable, userFamily);
                            // 封装画像数据
                            List<Row> rows = genderTagDF.collectAsList();
                            if (rows.size() > 0) {
                                Map<String, Map<String, String>> kvs = new HashMap<String, Map<String,String>>();
                                rows.forEach(row -> {
                                    Map<String, String> kv = new HashMap<String,String>();
                                    String rowKey = null;
                                    if (!row.isNullAt(0)) {
                                        rowKey = row.getString(0)+"";
                                        kv.put(userIdColumn, rowKey);
                                    }
                                    if (!row.isNullAt(1)) {
                                        kv.put(tagIdsColumn, row.getString(1));
                                    }
                                    if (!StringUtils.isEmpty(rowKey)) {
                                        rowKey = userFamilyAlias + rowKey;
                                    }
                                    // 取出本次计算完成用户ID和五级标签
                                    String newUserId = kv.get(userIdColumn);
                                    String newTagId = kv.get(tagIdsColumn);
                                    if (StringUtils.isEmpty(newUserId)||StringUtils.isEmpty(newTagId)) {
                                        logger.info("==== 本次计算完成，但是没有结果！ ====");//本次计算完成，但是没有结果
                                    } else {
                                        // 说明画像表是空表，直接新增
                                        if (existProfileData.size() == 0) {
                                            kvs.put(rowKey, kv);
                                        } else {// 如果不是空表，则验证
                                            Map<String, String> map = existProfileData.get(rowKey);
                                            // 没有该用户的画像数据，直接新增
                                            if (null == map) {
                                                kvs.put(rowKey, kv);
                                            } else {// 有该用户的画像数据，取出
                                                String existTagIds = map.get(tagIdsColumn);
                                                if (!StringUtils.isEmpty(existTagIds)) {
                                                    if (!existTagIds.contains(newTagId)) {// 用户存在，但本次计算的标签不存在
                                                        kv.put(tagIdsColumn, existTagIds+","+newTagId);//在已有的标签后面追加本次计算的标签
                                                        kvs.put(rowKey, kv);
                                                    } else {
                                                        logger.info("==== 该{}用户已存在ID={}的标签！ ====", rowKey, newTagId);
                                                    }
                                                }
                                            }
                                        }
                                    }
                                });
                                //写入画像表
                                build.addRows(profileTable, userFamily, kvs);
                                build.close();
                            } else {
                                logger.info("==== 作业计算完成，但计算结果为空！ ====");
                            }
                        }
                    }
                }
            }
        }
        
        @Override
        public void clear() {
            if (null != session) {
                session.close();
                logger.info("==== 释放SparkSQL相关资源 ====");
            }
        }
        
        public static void main(String[] args) {
            Tag8Model tagModel = new Tag8Model();
            tagModel.execute();
        }
        
    }
    
    ```
