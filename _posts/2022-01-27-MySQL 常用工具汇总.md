---
layout:     post
title:      MySQL 常用工具汇总
subtitle:   表维护 & DB运维
date:       2022-01-27
author:     dex0423
header-img: img/post-bg-os-metro.jpg
catalog: true
tags:
- 数据库
---



# 1. 表结构创建维护

- 修改 primary key

```aidl
# 删除原有主键
alter table tablename drop PRIMARY KEY

# 重新创建主键
alter table tablename ADD PRIMARY KEY('col_name')
```

- 添加索引

```aidl
create index `idx_add_time` on ods.ods_oms_product (add_time);

ALTER TABLE ods.ods_ad原始表 ADD KEY INDEX  idx_date(`日期`);

```

- 添加唯一键

```aidl
ALTER TABLE `sys_user` ADD unique uniq_username ( `username`,`org_id`)
```

- 复制表:

```
create table tb_test01 like tb_test02;
```

复制表数据:
```aidl
insert into tb_test01 select * from tb_test02;
```

- 修改表名

```aidl
alter table ods.`ods_oms_b2b_stock_out_order_detail_new` rename [to|as]  ods.`ods_oms_b2b_stock_out_order_detail`
```

- 修改列名

```aidl
alter table tab_name change[column] old_name new_name [first|after col_name]
```

- 添加时间戳字段

```aidl
alter table quant_stk_calc_d_wxcp add update_time timestamp DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP;
```

# 2. 清洗转换

##### 2.1. 数据探查

- 查看某字段不重复的全部值

  ```SELECT DISTINCT(字段) FROM test.test;```


##### 2.2. 数据校验

- 正则表达式：检测科学计数法

  ```SELECT * FROM test.test WHERE 日期 regexp '[E|e]+';```

- 检测空值

  ```SELECT * FROM test.test WHERE ISNULL(非空字段)=1;```

##### 2.3. 数据转换

- SQL 替换字符串

  ```aidl
  update [表名] set 字段名 = replace(与前面一样的字段名,'原本内容','想要替换成什么')
  ```



# 3. 运维配置

- 卸载&清除残留文件
```aidl
sudo apt purge mysql-*

sudo rm -rf /etc/mysql/ /var/lib/mysql

sudo apt autoremove 

sudo apt autoclean

或者：

sudo apt-get remove mysql-*

dpkg -l |grep ^rc|awk '{print $2}' |sudo xargs dpkg -P

```

- 修改密码
```aidl
use mysql;

GRANT ALL PRIVILEGES ON *.* TO 'root'@'%' IDENTIFIED BY '123456' WITH GRANT OPTION; --创建远程root用户并设置密码

flush privileges;
```

- 查看端口号
```aidl
show global variables like 'port';
```

##### 4. 异常处理

- Invalid for this platform protocol requested

  - 问题：
    - 使用 workbench 连接 MySQL 数据库，workbench 客户端连接失败，
  
  - 报错：
    ```aidl
    Invalid for this platform protocol requested(MYSQL_PROTOCOL_SOCKET)
    ```
    
  - 处理方法：
    - 删除现有的连接，从头开始、重新创建一个连接。
  

`