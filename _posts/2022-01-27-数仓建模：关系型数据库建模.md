---
layout:     post
title:      数仓建模：关系型数据库建模
subtitle:   
date:       2022-01-27
author:     dex0423
header-img: img/post-bg-os-metro.jpg
catalog: true
tags:
    - 数仓
---

# 1. 常见模型

##### 1.1. 三范式模型

- 范式：
  - 范式，是符合某一种设计要求的总结；
  - 为了建立冗余较小、结构合理的数据库，设计数据库时必须遵循一定的规则。在关系型数据库中这种规则就称为范式。
  - 三范式
  - 第一范式：
    - 确保每列保持原子性，即要求数据库表中的所有字段值都是不可分解的原子值；
  - 第二范式：
    - 确保表中的每列都和主键相关。也就是说在一个数据库表中，一个表中只能保存一种数据，不可以把多种数据保存在同一张数据库表中。
    - 作用：减少了数据库的冗余
  - 第三范式：
    - 确保每列都和主键列直接相关，而不是间接相关。

- 主数据表；
- 参照数据表；
- Xref 表；
- 事务表；

##### 1.2. 星型模型

- 事实表；
- 维度表；
- 桥表；
- 支架表；

# 2. 实体 Entity

##### 2.1. 实体的定义

- 实体，是具体事物的抽象化描述，是数据库中存储的所有信息；
- 实体，对应数据库的表；
- 实体中的实例，指的就是一行行的数据。

>实体，通常指的是业务场景中【名词】，也指一个要处理的抽象的【对象】。

##### 2.2. 实体的分类

![]({{site.baseurl}}/img-post/数仓建模-关系型数据库建模-1.png)

# 3. 属性 Attribute

##### 3.1. 属性的定义

- 属性，对应的是表的列；
- 在关系型数据库中，属性通常都是单值的；
  - 如果存在多值，则需要另外建属性表；

##### 3.2. 属性的分类

- ID；
  - 标识实体的唯一性，一般是唯一主键；
- 描述；
- 引用；
  - 引用的其他实体的信息，比如订单表中会引入商品信息、客户信息，就需要加入商品ID、客户ID；
- 分类；
  - 实体所属的分类，比如客户分为国内客户、国外客户；
  - 注意：不同分类方法，会对应不同的属性值，需要注意对应关系和唯一性；
- 限制；
  - 比如：最低价格；
- 数量；
  - 比如：订单的采购数量、交易的金额等；
- 时间相关；
  - 日期型；
  - 时间戳性；
  - 时间型；
- 人物相关；
  - 比如：企业法人；
- 组织相关；
  - 比如：销售门店；
- 地点相关；
  - 比如：城市、国家、IP地址；
- 途径相关；
  - 比如：销售途径平台电商、自建独立站、直播间、代理商；
- 站点相关；
  - 比如：APP、web 站；
- 状态；
  - 比如：员工在职、离职；
- 审计；
  - 数仓中最常用的；
  - 创建、修改间戳；
    - 比如：add_time、update_time；
  - 操作人； 
    - 订单录入人、系统自动生成等；
  - 数据来源；
    - 数据的来源；
    - 比如：客户姓名、来自于客户信息系统，就要标注客户信息系统ID；
- 派生；
  - 预计算数据；
  - 数据内容的 MD5 校验码；
    - ETL 数据对账中经常使用；

##### 3.3. 属性的特性

- 强制 / 可选
  - 属性值是否可以为空；
- 原子 / 组合
  - 比如：姓、名都是原子的，二者在一起，组合构成姓名；
- 直接 / 派生
  - 比如：国家 + 省 + 城市 + 街道 + 门牌号 = 详细地址；
- 单值 / 多值
  - 关系型数据，不支持单实体、多属性，否则会违反 3NF，需要单独建子表；
- 可选键
  - 某一属性、或多个属性，可以作为判断唯一性的标识，即唯一键；
- 数据类型
  - INT、CHAR、DATE 等等；
- 默认值
  - 如果没有值，则赋与其默认值；
  - 比如：审计中的更新时间，为系统自动生成时间 current timestamp；
- 派生属性计算逻辑
  - 比如：手机号前缀（如+86） + 手机号 = 完整手机号；

# 4. 值域 Domain

##### 4.1. 值域的定义

- 值域，指的是属性所有取值范围的集合；
- 值域，可以理解为自定义的数据类型，同时可以加上约束条件；
- 值域范围，需要根据实际的业务场景决定取值范围；

##### 4.2. 值域的类型

- 格式：
  - varchar；
  - currency；
  - email；
    - 正则表达式匹配 @ 符：
  - 身份证号；
    - 位数限制、校验码；
  - 等等；
- 列表：
  - 枚举；
    - 比如：销售渠道包含淘宝店、京东店铺、抖音店铺，除此以外的值都是非法；
  - 月份；
    - 从 1月 到 12 月；
  - 性别；
    - Male、Female、Unknown；
  - 名称：
    - LongName：VARCHAR(255)，容纳公司名称、其他名称；
    - ShortName：VARCHAR(50)，容纳人名、部门名称；
  - 等等；
- 范围：
  - 年龄：0 ~ 100；
  - 角度：-180 ~ +180；


##### 4.3. 值域的作用

- 数据质量：
  - 值域范围规范，可以大幅提高数据质量；
- 易懂易用：
  - 数据模型会更加容易理解和使用；
- 数据标准化：
  - 提高模型质量和建模效率；

##### 4.4. 值域的应用

- PostgreSQL、Oracle；

>注意：MySQL，不支持值域！！！

# 5. 关系

##### 5.1. 



##### 5.2. 



# 6. 键 Key

##### 6.1. 候选键

- 一个或多个属性的结合，可以确定唯一实体；
- 比如：
  - 员工编号、员工邮箱，都是唯一的，可以作为候选键；

##### 6.2. 主键

- 从候选键中，选中作为唯一标识的属性、或者属性组；

- 主键的特点：
  - 唯一性：不可重复；
  - 强制性：不可以为空；
  - 永久性：不可以改变；
  - 最小集合：不可以掺杂多余的属性；
    >如果两个字段可以作为联合主键确定唯一值，就没有必要再加上第三个字段；
    
- 设计主键要注意的问题：
  - 尽量不要使用 SmartKey；
    - SmartKey，指的是存在含义的编码 Key；
    - 比如：身份证号码，对应位置的数值，是有特殊含义的，比如行政区域，这就存在超级辖区人口数量暴增，导致数值溢出的风险；
  - 不要将 ID 编码植入程序，
    - 否则一旦编码变化、程序会出现很大问题。
    - 比如：部门编码，指定位置指定对应的部门，但是如果组织架构调整，就会出现问题；
  - 不能随着环境变化而收到影响
    - 设计之初，就要考虑未来可能遇到的场景；
  - 键值应易管理、易维护；
    - 不要有人工输入；

##### 6.3. 单键 & 复合键

- 单键：
  - 主键只有一个属性，称为单键；
- 复合键：
  - 主键是多个属性的组合，称为复合键；

##### 6.4. 自然键 & 代理键

- 自然键：
  - 已经真实存在的键，通常具有真实的商业含义；
  - 可以使单键，也可以是复合键；
  - 灵活性：
    - 自然键做主键，实体主键的变化、会带来外键相关表的连锁反应；
    - 一旦 update，只能删除重做；
  - 
- 代理键：
  - 完全没有商业含义，通常由系统自动生成；
  - 灵活性：
    - 代理键本身无意义，可以修改原自然键内容；
    - 代理键 update 会更加容易；
  - 使用场景：
    - 完全没有自然键做主键；
    - 分布式结构数据库，多联合主键的事实表，为了分区方便，创建单独的代理键，以避免数据分区的偏移；
- 外键：
  - 引用其他表的主键；

##### 6.3. 可选键

- 候选键中，没有选中的其他键；

##### 6.4. 键的命名规则

- 自然键
- 代理键
  - xxx_SK
- Checksum key
  - xxx_CK

# 7. 约束

##### 7.1. 唯一标识


##### 7.2. 非空约束


##### 7.3. 默认值


##### 7.4. 检查


##### 7.5. 参照完整性


# 8. 建模工具

- Powerdesigner
- ERwin；
- Datablau；