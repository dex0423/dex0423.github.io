---
layout:     post
title:      数仓工具：数仓部署&运维常用脚本
subtitle:   rsync递归数据分发
date:       2022-01-27
author:     dex0423
header-img: img/post-bg-os-metro.jpg
catalog: true
tags:
    - 数仓
---


# 1. 脚本编写注意事项

##### 1.1. 使用 linux vim 编辑器
- 脚本编写，最好先在 Windows 环境下，编辑好，再粘贴到 linux 的 vim 编辑器；
- 不能直接将脚本推送到 linux 中，否则执行的时候会因为回车问题，导致脚本无法正常运行。

##### 1.2. 脚本存放到 bin 目录下
- 写好的脚本放到 /bin 目录下，可以直接执行；

##### 1.3. 修改 777 权限
- `chmod 777 脚本名称`

##### 1.4. 注意脚本后缀
- 不要后缀的脚本要注意；

# 2. xsync

##### 2.1. xsync 简介

改脚本基于 rsync 而写的，rsync 与 scp 的运行机制不一样，rsync 会对比集群内同目录下是否有不一致，如果有不一样的文件则同步文件过去，如果一致则不更新。

##### 2.2. xsync 脚本

- 在 bin 目录下创建 xsync；
  
    ```aidl
    cd /bin & vim xsync
    ```

- 编辑脚本；
  
    ```aidl
    #!/bin/sh
    
    # 获取输入参数个数，如果没有参数，直接退出
    pcount=$#
    if((pcount!=4)); then
        echo Usage: $0 filename servername startno endno
        exit;
    fi
    
    
    # 获取文件名称
    p1=$1
    fname=`basename $p1`
    echo fname=$fname
    
    # 获取上级目录到绝对路径
    pdir=`cd -P $(dirname $p1); pwd`
    echo pdir=$pdir
    # 获取当前用户名称
    user=`whoami`
    # 获取hostname及起止号
    slave=$2
    startline=$3
    endline=$4
    
    # 循环
    for((host=$startline; host<=$endline; host++)); do
        echo $pdir/$fname $user@$slave$host:$pdir
        echo ==================$slave$host==================
        rsync -rvl $pdir/$fname $user@$slave$host:$pdir
    done
    ```
  
- 修改权限

    ```aidl
    chmod 777 xsync
    ```

##### 2.3. xsync 使用

- 使用示例：

    ```aidl
    [root@hadoop-1 home]# sudo xsync 1.txt slave 1 2
    
    fname=1.txt
    pdir=/home
    /home/1.txt root@slave1:/home
    ==================slave1==================
    sending incremental file list
    1.txt
    
    sent 90 bytes  received 35 bytes  83.33 bytes/sec
    total size is 2  speedup is 0.02
    /home/1.txt root@slave2:/home
    ==================slave2==================
    sending incremental file list
    1.txt
    
    sent 90 bytes  received 35 bytes  250.00 bytes/sec
    total size is 2  speedup is 0.02
    ```

# 3. javapsall 脚本

- 建立 jps 软链接

    ```
    ln -s /usr/local/jdk1.8/bin/jps /usr/local/bin/jps
    ```

- 在 `/usr/local/bin` 路径下编辑 `javapsall` 脚本

    ```
    for host in hadoop102 hadoop103 hadoop104
    do
    echo "==========  $host  ========="
    ssh $host "jps" | grep -v Jps
    done
    ```
- 修改 javapsall 权限

    ```
    chmod 777 javapsall
    ```
- 测试结果

    ```
    [root@hadoop102 bin]# javapsall
    ==========  hadoop102  =========
    ==========  hadoop103  =========
    ==========  hadoop104  =========
    ```

# 4. xcall 集群内执行命令

##### 4.1. 编辑 xcall
```
cd /usr/local/bin
vim xcall
```

```aidl
#!/bin/bash
pcount=$#
if((pcount==0));then
        echo "没有参数！";
        exit;
fi
echo -------hadoop102------
$@
for((host=2; host<=4; host++)); do
        echo -------hadoop10$host------
        ssh hadoop10$host $@
done
```

```aidl
chmod 777 xcall
```

##### 4.2. xcall 使用示例

```aidl
xcall jps


-------hadoop102------
12712 Jps
-------hadoop102------
12727 Jps
-------hadoop103------
7648 ResourceManager
8278 Jps
7791 NodeManager
-------hadoop104------
15047 Jps

```
