---
layout:     post
title:      数据埋点：数据埋点系统搭建
subtitle:   
date:       2022-01-27
author:     dex0423
header-img: img/post-bg-os-metro.jpg
catalog: true
tags:
    - 数据埋点
---


# 埋点需求梳理

#### 埋点需求基本要素

- 上报时间
- 涉及页面
- 用户信息
- 系统信息
- 触发条件（session 回溯）
- 上报位置

#### 埋点日志基本字段

- 用户 ID
- 事件名称
- 事件 ID
- 所在页面（位置）
- 属性
- 属性值
- 时间
  - 设备上报时间
  - 到达服务器的时间
- 公共字段示例：
  ```aidl
  "cm": {  //公共字段
          "mid": "",  // (String) 设备唯一标识
          "uid": "",  // (String) 用户标识
          "vc": "1",  // (String) versionCode，程序版本号
          "vn": "1.0",  // (String) versionName，程序版本名
          "l": "zh",  // (String) 系统语言
          "sr": "",  // (String) 渠道号，应用从哪个渠道来的。
          "os": "7.1.1",  // (String) Android系统版本
          "ar": "CN",  // (String) 区域
          "md": "BBB100-1",  // (String) 手机型号
          "ba": "blackberry",  // (String) 手机品牌
          "sv": "V2.2.1",  // (String) sdkVersion
          "g": "",  // (String) gmail
          "hw": "1620x1080",  // (String) heightXwidth，屏幕宽高
          "t": "1506047606608",  // (String) 客户端日志产生时的时间
          "nw": "WIFI",  // (String) 网络模式
          "ln": 0,  // (double) lng经度
          "la": 0  // (double) lat 纬度
      }
  ```

- 自定义事件示例：

  ![]({{site.baseurl}}/img-post/埋点需求示例.png)

- 全埋点事件示例：

  ![]({{site.baseurl}}/img-post/埋点需求示例-2.png)

# 埋点系统模块

#### 事件管理

- 事件 ID
- 事件名称
- 时间中文名称
- 事件类型
- 事件描述
- 所属页面
- 页面 ID
- 属性（Key）
- 属性值（Value）
- 属性值类型
  - 字符串
  - 数值
  - 时间
  - ...
- 属性值示例
- 埋点方式
  - 代码埋点
  - 可视化圈选埋点
  - 全埋点
  - SDK
- 触发条件
- 上报方式
  - 实时上报
  - 延时上报
    - 延时时间
    - 缓存位置
- 状态
  - 提交审核
  - 审核中
  - 审核完成
  - 开发中
  - 开发完成
  - 测试中
  - 测试完成
  - 待上线
  - 上线
  - 下线（逻辑删除）
- 平台
  - H5
  - 小程序
  - web
    - JS
  - 安卓
  - IOS
- 版本
  - 版本号
  - 埋点增减说明
- 备注

#### 页面管理

- 功能模块
- 页面名称
- 页面中文名称
- 上游页面
- 下游页面
- 区块（模块位置）
- 组件
  - 商品
  - 入口
  - 广告

#### 公共数据管理

- 公共数据
  - 手机号
  - UUID
  - open ID
  - 网络格式
  - 经纬度（坐标）
  - 省份
  - 城市
- 属性 1
  - 是否必填
- 属性 2
  - 平台
    - 安卓
    - iOS
    - 小程序
    - web
- 属性 3
  - ...

#### 元数据管理
  
- 事件类型
  - 点击
  - 曝光
  - 播放
  - 收藏
  - 转发
  - 加购
  - 下单
  - 支付
  - 退货
  - 投诉
- 功能模块
- 平台
- 版本
- 组件

#### 埋点位置

- 页面打开 / 关闭
- 模块曝光展示
- 文本输入 & 搜索
- 鼠标点击 & 拖动 & 翻页
- 点赞、评论、分享
- 按钮控件触发
  - 在网页不同位置，控件触发的概率是不一样的，需要注意埋点的位置；
  - 网页热力图：
    ![]({{site.baseurl}}/img-post/数据埋点-1.png)

#### 埋点测试

- 是否正常触发
- 触发时机是否正确
- 报送内容是否准确、完整
- 前端校验
  - debugger 断点
- 后端校验
  - 数据库验证

#### 可视化

- 埋点统计

- 可视化分析

# 埋点系统项目管理

#### 埋点系统搭建工作流程

- 梳理埋点需求（分析指标体系）
- 制定埋点规则
  - 命名的规范化
  - 埋点流程统一化
- 制定埋点数据的清洗规则
  - 数据清洗规范化
- 维护埋点的测试、上线、下线
- 维护埋点元数据（埋点管理系统）


#### 数据埋点项目实施方案

- 采集
  - 自主开发采集
    - Nginx
    - Logstash
    - API
  - 第三方 SDK
    - 神策 SDK（鬼策 SDK）
    - 易观 SDK
    - 诸葛 SDK
    - Mixpanel
    - 阿里开源 SDK
- 存储
  - 通用存储
    - TiDB
    - Hive
    - ES
  - OLAP（性能更佳）
    - Clickhouse（今日头条、B站）
      - 查询并发比较小，只支持几百并发查询
    - Impala（神策在用的引擎）
    - Druid
    - Kylin
    - Presto
- 可视化
  - 通用 BI产品
    - PowerBI
    - Tableau
    - Metabase
    - Superset
  - 自研可视化
    - 百度 Echarts

#### 开发思路

- 小公司：开源 SDK + 通用存储 + 通用 BI
- 大公司：开源 SDK + OLAP 引擎 + 自研可视化


#### 埋点项目开发流程示例

![]({{site.baseurl}}/img-post/指标体系方法论-4.png)

# 第三方工具产品

#### 埋点工具产品

- 神策 SensorData
- 字节 DataFinder
- Growing IO
- Tracking IO
- TalkingData
- 诸葛 IO
- 友盟
- 阿里 SDK
- 百度移动分析
- 腾讯移动分析
- 易观
- 阿拉丁
- Google Analytics
- FireBase
- Fabric
- Mixpanel
- Amplitude
- Heap

- 选择工具要注意的问题：
  - 数据安全性（国外产品尤其注意）
  - 数据隐私性
  - 访问速度
  - 数据丢失
  - 使用体验
  - 学习成本

#### 第三方工具存在的问题

- 非实时反馈
- 数据波动难以定位
- 与第三方沟通成本太高
- 没有自己的核心数据存储
- 第三方数据粒度太粗，不能适应精细化运营需求