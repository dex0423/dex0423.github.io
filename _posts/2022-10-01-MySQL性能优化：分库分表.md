---
layout:     post
title:      MySQL性能优化：分库分表
subtitle:   
date:       2022-02-01
author:     dex0423
header-img: img/post-bg-universe.jpg
catalog: true
tags:
    - 数据库
---


# MySQL分库分表

#### 分库分表的基本原理
- 为什么要分库分表
  - 用户请求量太，但是单服务器 TPS，内存，IO 都是有限的；
  - 单库太大，单库所在服务器上磁盘空间不足，单库处理能力有限，存在 IO 瓶颈；
  - 单表太大，索引膨胀，查询超时；
- 分库分表的目标
  - 分表，可以解决单表海量数据的读写性能问题；
  - 分库，可以解决单台数据库的并发访问压力问题。
- 拆分思路
  - 垂直拆分，垂直分库、垂直分表
  - 水平拆分，水平分库、水平分表
>垂直拆分：是指按功能模块拆分，**垂直拆分解决表与表之间的 I/O 竞争**。比如分为订单库、商品库、用户库...这种方式多个数据库之间的表结构不同。
水平拆分：将同一个表的数据进行分块保存到不同的数据库中，**水平拆分解决单表中数据量增长出现的压力**。这些数据库中的表结构完全相同。
- 分库分表的顺序
  **分库分表的顺序应该是先垂直分，后水平分**。因为垂直分更简单，更符合我们处理现实世界问题的方式。

#### 垂直分表
垂直分表，是基于列（字段）对表格进行横向拆分。
- 垂直分表规则：
  - 数据较大的字段，单独存表；
  - 不常用的的字段，单独存表；
  - 经常一起使用的字段，放在一起存表；
  - 长度较长（比如text类型字段）的字段，单独存表；
>垂直分表，一般是针对那种几百列的大表，也避免查询时，数据量太大造成的“跨页”问题。

分表能够解决单表数据量过大带来的查询效率下降的问题，但是，却无法给数据库的并发处理能力带来质的提升。面对高并发的读写访问，当数据库master服务器无法承载写操作压力时，不管如何扩展slave服务器，此时都没有意义了。因此，我们必须换一种思路，对数据库进行拆分，从而提高数据库写入能力，这就是所谓的分库。

#### 垂直分库
垂直分库，是针对一个系统中的不同业务进行拆分，比如用户User一个库，商品Producet一个库，订单Order一个库。
>**垂直切分后，一般放在多个服务器上，而不是一个服务器上**。这是因为，一个购物网站对外提供服务，会有用户，商品，订单等的CRUD。没拆分之前， 全部都是落到单一的库上的，这会让数据库的单库处理能力成为瓶颈。

按垂直分库后，如果还是放在一个数据库服务器上， 随着用户量增大，这会让单个数据库的处理能力成为瓶颈，还有单个服务器的磁盘空间，内存，tps等非常吃紧。 所以我们要拆分到多个服务器上，这样上面的问题都解决了，以后也不会面对单机资源问题。
数据库往往最容易成为应用系统的瓶颈，而数据库本身属于“有状态”的，相对于Web和应用服务器来讲，是比较难实现“横向扩展”的。 数据库的连接资源比较宝贵且单机处理能力也有限，在高并发场景下，垂直分库一定程度上能够突破IO、连接数及单机硬件资源的瓶颈。数据库业务层面的拆分，能对不同业务的数据分别的进行管理，维护，监控，扩展等。

#### 水平分表（不单独使用）
针对数据量巨大的单张表（比如订单表），按照某种规则（RANGE,HASH取模等），切分到多张表里面去。
- 水平分表的问题：
  - 但是这些表还是在同一个库中，所以库级别的数据库操作还是有IO瓶颈。
  - 无法进行跨表直连连接查询；
  - 统计数据不方便；
  - 如果数据持续增长，达到现有分表的瓶颈，需要增加分表时、会出现数据重新排列的情况。
> 生产环境中，水平分表一般不单独使用，而是和水平分库一起使用，做水平分库分表。

#### 水平分库（一般与水平分表同时使用）
将单张表的数据切分到多个服务器上去，每个服务器具有相应的库与表，只是表中数据集合不同。水平分库分表能够有效的缓解单机和单库的性能瓶颈和压力，突破IO、连接数、硬件资源等的瓶颈。
- 水平分库分表策略：
  - 用户 id 取模；
  - 如果不是整数，可以进行 hash 获取到整数；
  - 按照地理区域拆分；
  - 按照时间拆分；
  - 按照【冷热数据】拆分；

#### 分库分表的标准
- 什么样的情况需要分库分表：
  - 表体积大于 2G，行数大于 1000 万；
  - 表中含有 text、blob、varchar(1000)；
  - 数据有时效性，可以单独拿出来归档；
- 分库分表的大小多少合适
  分表最大分1024，一般分100左右比较适合。

#### 分库分表存在的问题
- 维度的问题
  假如用户购买了商品,需要将交易记录保存取来，如果按照用户的纬度分表，则每个用户的交易记录都保存在同一表中，所以很快很方便的查找到某用户的 购买情况，但是某商品被购买的情况则很有可能分布在多张表中，查找起来比较麻烦。反之，按照商品维度分表，可以很方便的查找到此商品的购买情况，但要查找 到买人的交易记录比较麻烦。
>维度的问题解决办法：记录【两份数据】，一份按照用户纬度分表，一份按照商品维度分表。
- 联合查询的问题
  联合查询基本不可能，因为关联的表有可能不在同一数据库中。这是因为分库分表后表之间的关联操作将受到限制，我们无法join位于不同分库的表，也无法join分表粒度不同的表， 结果原本一次查询能够完成的业务，可能需要多次查询才能完成。
  联合查询问题的解决方法：
  - 全局表：基础数据，所有库都拷贝一份；
  - 字段冗余：这样有些字段就不用join去查询了；
  - 系统层组装：分别查询出所有，然后组装起来，较复杂。
- 跨库事务问题
  **避免在一个事务中修改db0中的表的时候、同时修改db1中的表**，一个是操作起来更复杂，效率也会有一定影响。
  分库分表后，就成了分布式事务了。如果依赖数据库本身的分布式事务管理功能去执行事务，将付出高昂的性能代价； 如果由应用程序去协助控制，形成程序逻辑上的事务，又会造成编程方面的负担。
- 数据依赖问题
  例如卖家a的商品和交易信息都放到db0中，当db1挂了的时候，卖家a相关的东西可以正常使用。**尽量把同一组数据放到同一DB服务器上**，避免数据库中的数据依赖另一数据库中的数据。

#### 分库分表产品方案
- MySQL Proxy；
- Amoeba；
- Hibernate Shards；
- sharding-jdbc；