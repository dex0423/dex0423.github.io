---
layout:     post
title:      数仓建模：数仓建模的几种方法
subtitle:   范式建模 & 维度建模 & 星型模型 & 雪花模型 & Data Value & Anchor
date:       2022-01-27
author:     dex0423
header-img: img/post-bg-os-metro.jpg
catalog: true
tags:
    - 数仓
---


# 1. 常见的数据建模方法

数据仓库本质是从数据库衍生出来的，所以数据仓库的建模也是不断衍生发展的。从最早的借鉴数据库的范式建模，到逐渐提出维度建模，Data Vault模型，Anchor模型等等，越往后建模的要求越高，越需满足3NF,4NF等。但是对于数据仓库来说，目前主流还是维度建模，会夹杂着范式建模。

  ![]({{site.baseurl}}/img-post/数仓建模方法-1.png)

# 2. 范式建模

##### 2.1. 三范式 & 四范式 & 五范式：

- 第一范式：
  - 保证数据的原子性，没有重复列，列不可再分，也没有重复行；
  - 数据规整成二维表；
  - 确保每一列表达同一含义；
    - 比如成绩中，分数和评价，要拆分成两列；
  - 去掉多值属性；
    - 比如：地址信息，拆分成省、市、区、详细地址；
  - 拆成多列；
    - 比如：一个人有多个电话号码，应拆分成电话_1、电话_2；
  - 去掉重复组，挪到新表里面；
    - 不好拆分的列，可以单独建表；
    - 比如：每个人都有多个电话，就可以单独建一个电话号码表，新表中每一行、写入一组人员ID+电话号码；
  - 确定主键；
    - 确保每一行都是唯一的；
    
- 第二范式：
  - 确保表中的每列都和主键相关；
  - 也就是说在一个数据库表中，一个表中只能保存一种数据，不可以把多种数据保存在同一张数据库表中；
  - 如果不遵守第二范式：
    - 会比存在数据冗余；
    - 同时存在数据不一致的风险；
    - 另外，关系也会被隐藏在表中，不能很直观的展示出来；
  - 比如：下方学生成绩表中，学生姓名、学生课程，各自都只与主键学号有关，这是就应该拆分成两个表；
    ![]({{site.baseurl}}/img-post/数仓建模-数仓建模注意的问题-1.png)

- 第三范式

  - 非主键属性只能依赖于主键，不能依赖于其他非主键属性；
  - 如果非主键属性、依赖于其他非主键属性，则需要移出去创建新表；
  - 比如：下方学生班级成绩表中，班级名称依赖于班级编号，而不是主键学号，这是就应该分拆成两个表；
    ![]({{site.baseurl}}/img-post/数仓建模-数仓建模注意的问题-2.png)


- BCNF

  - BCNF 中，任何属性（包括主属性和非主属性），都不能被非主属性所决定；
  - BCNF 必须规避下面的问题：
    - 存在联合主键；
    - 存在多个可选键；
      - 可选键存在重叠；
    - 比如：下表中，班级+课程、班级+教师，都可以作为联合主键，就可以拆分成两个表；
      ![]({{site.baseurl}}/img-post/数仓建模-数仓建模注意的问题-3.png)


- 第四范式

  - 多值依赖；
    - 多值依赖：三个属性A、B、C在一起做联合主键，AB、AC都存在依赖关系，并且B和C之间没有依赖关系；
    - 第四范式就是要消除多值依赖；
  - 比如：下表中，学号、课程、语言做联合主键，学号+课程、学号+语言，是相互依赖的，但是课程和语言没有依赖关系，这时候就要拆分成两个表；  
    ![]({{site.baseurl}}/img-post/数仓建模-数仓建模注意的问题-4.png)
  - 第四范式下：
    - 数据冗余会减少；
    - 数据关系会更清晰；

- 第五范式

  - 连接依赖：
    - 连接依赖：三个属性A、B、C在一起做联合主键，AB、AC、BC都存在依赖关系；
    - 第五范式就是要消除连接依赖；

  ![]({{site.baseurl}}/img-post/数仓建模-数仓建模注意的问题-5.png)

- 范式模型常见表类型：
  - 主数据表；
  - 参照数据表；
  - Xref 表；
  - 事务表；

- 三范式的优点：
  - 减少冗余，同一含义的数据只存一份；


#### 2.2. E-R 模型

- 实体 Entity
  - 实体的定义
    - 实体，是具体事物的抽象化描述，是数据库中存储的所有信息；
    - 实体，对应数据库的表；
    - 实体中的实例，指的就是一行行的数据。

  >实体，通常指的是业务场景中【名词】，也指一个要处理的抽象的【对象】。

  - 实体的分类
    ![]({{site.baseurl}}/img-post/数仓建模-关系型数据库建模-1.png)

- 关系 Relationship
    ![]({{site.baseurl}}/img-post/数仓建模方法-2.png)

  - 一对一
    - 指实体之间的关系是一一对应的，比如个人与身份证信息之间的关系就是一对一的关系。

  - 一对多
    - 指一边的实体通过关系，可以对应多个另外一边的实体。相反，另外一边的实体通过这个关 系，则只能对应唯一的一边的实体。比如说，我们新建一个班级表，而每个班级都有多个学生，每个学生则对应一个班级，班级对学生就是一对多的关系。

  - 多对一
    - 与一对多情况相反。

  - 多对多
    - 指关系两边的实体都可以通过关系对应多个对方的实体。比如在进货模块中，供货商与超市之 间的关系就是多对多的关系，一个供货商可以给多个超市供货，一个超市也可以从多个供货商那里采购 商品。

- 属性 Attribute
  - 属性的定义
    - 属性，对应的是表的列；
    - 在关系型数据库中，属性通常都是单值的；
    - 如果存在多值，则需要另外建属性表；
  - 属性的分类
    - ID；
      - 标识实体的唯一性，一般是唯一主键；
    - 描述；
    - 引用；
      - 引用的其他实体的信息，比如订单表中会引入商品信息、客户信息，就需要加入商品ID、客户ID；
    - 分类；
      - 实体所属的分类，比如客户分为国内客户、国外客户；
      - 注意：不同分类方法，会对应不同的属性值，需要注意对应关系和唯一性；
    - 限制；
      - 比如：最低价格；
    - 数量；
      - 比如：订单的采购数量、交易的金额等；
    - 时间相关；
      - 日期型；
      - 时间戳性；
      - 时间型；
    - 人物相关；
      - 比如：企业法人；
    - 组织相关；
      - 比如：销售门店；
    - 地点相关；
      - 比如：城市、国家、IP地址；
    - 途径相关；
      - 比如：销售途径平台电商、自建独立站、直播间、代理商；
    - 站点相关；
      - 比如：APP、web 站；
    - 状态；
      - 比如：员工在职、离职；
    - 审计；
      - 数仓中最常用的；
      - 创建、修改间戳；
        - 比如：add_time、update_time；
      - 操作人；
        - 订单录入人、系统自动生成等；
      - 数据来源；
        - 数据的来源；
        - 比如：客户姓名、来自于客户信息系统，就要标注客户信息系统ID；
    - 派生；
      - 预计算数据；
      - 数据内容的 MD5 校验码；
        - ETL 数据对账中经常使用；

  - 属性的特性
    - 强制 / 可选
      - 属性值是否可以为空；
    - 原子 / 组合
      - 比如：姓、名都是原子的，二者在一起，组合构成姓名；
    - 直接 / 派生
      - 比如：国家 + 省 + 城市 + 街道 + 门牌号 = 详细地址；
    - 单值 / 多值
      - 关系型数据，不支持单实体、多属性，否则会违反 3NF，需要单独建子表；
    - 可选键
      - 某一属性、或多个属性，可以作为判断唯一性的标识，即唯一键；
    - 数据类型
      - INT、CHAR、DATE 等等；
    - 默认值
      - 如果没有值，则赋与其默认值；
      - 比如：审计中的更新时间，为系统自动生成时间 current timestamp；
    - 派生属性计算逻辑
      - 比如：手机号前缀（如+86） + 手机号 = 完整手机号；

- 值域 Domain

  - 值域的定义

    - 值域，指的是属性所有取值范围的集合；
    - 值域，可以理解为自定义的数据类型，同时可以加上约束条件；
    - 值域范围，需要根据实际的业务场景决定取值范围；

  - 值域的类型

    - 格式：
      - varchar；
      - currency；
      - email；
        - 正则表达式匹配 @ 符：
      - 身份证号；
        - 位数限制、校验码；
      - 等等；
    - 列表：
      - 枚举；
        - 比如：销售渠道包含淘宝店、京东店铺、抖音店铺，除此以外的值都是非法；
      - 月份；
        - 从 1月 到 12 月；
      - 性别；
        - Male、Female、Unknown；
      - 名称：
        - LongName：VARCHAR(255)，容纳公司名称、其他名称；
        - ShortName：VARCHAR(50)，容纳人名、部门名称；
      - 等等；
    - 范围：
      - 年龄：0 ~ 100；
      - 角度：-180 ~ +180；

  - 值域的作用

    - 数据质量：
      - 值域范围规范，可以大幅提高数据质量；
    - 易懂易用：
      - 数据模型会更加容易理解和使用；
    - 数据标准化：
      - 提高模型质量和建模效率；

  - 值域的应用

    - PostgreSQL、Oracle；

      >注意：MySQL，不支持值域！！！
  
- 键 Key

  - 候选键

    - 一个或多个属性的结合，可以确定唯一实体；
    - 比如：
      - 员工编号、员工邮箱，都是唯一的，可以作为候选键；

  - 主键

    - 从候选键中，选中作为唯一标识的属性、或者属性组；

    - 主键的特点：
      - 唯一性：不可重复；
      - 强制性：不可以为空；
      - 永久性：不可以改变；
      - 最小集合：不可以掺杂多余的属性；
        >如果两个字段可以作为联合主键确定唯一值，就没有必要再加上第三个字段；

    - 设计主键要注意的问题：
      - 尽量不要使用 SmartKey；
        - SmartKey，指的是存在含义的编码 Key；
        - 比如：身份证号码，对应位置的数值，是有特殊含义的，比如行政区域，这就存在超级辖区人口数量暴增，导致数值溢出的风险；
      - 不要将 ID 编码植入程序，
        - 否则一旦编码变化、程序会出现很大问题。
        - 比如：部门编码，指定位置指定对应的部门，但是如果组织架构调整，就会出现问题；
      - 不能随着环境变化而收到影响
        - 设计之初，就要考虑未来可能遇到的场景；
      - 键值应易管理、易维护；
        - 不要有人工输入；

  - 单键 & 复合键

    - 单键：
      - 主键只有一个属性，称为单键；
    - 复合键：
      - 主键是多个属性的组合，称为复合键；

  - 自然键 & 代理键

    - 自然键：
      - 已经真实存在的键，通常具有真实的商业含义；
      - 可以使单键，也可以是复合键；
      - 灵活性：
        - 自然键做主键，实体主键的变化、会带来外键相关表的连锁反应；
        - 一旦 update，只能删除重做；
    
    - 代理键：
      - 完全没有商业含义，通常由系统自动生成；
      - 灵活性：
        - 代理键本身无意义，可以修改原自然键内容；
        - 代理键 update 会更加容易；
      - 使用场景：
        - 完全没有自然键做主键；
        - 分布式结构数据库，多联合主键的事实表，为了分区方便，创建单独的代理键，以避免数据分区的偏移；
    - 外键：
      - 引用其他表的主键；

  - 可选键

    - 候选键中，没有选中的其他键；

  - 键的命名规则

    - 自然键
    - 代理键
      - xxx_SK
    - Checksum key
      - xxx_CK

- 约束

  - 唯一标识，unique key；
  - 非空约束，not null；
  - 默认值，default；
  - 检查，属性取值符合规则；
  - 外键约束：参照完整性；
  - 实体完整性：主键属性不为空；

##### 2.3. 范式建模关键点

- 第一范式必须严格遵守；
- 数据与数据的关系，用表关联的方式体现出来，而不是用数据内容来体现；
- 尽可能的减少冗余，同一含义的数据只存一分。
- 第四范式和第五范式，可以参考但实际不常用；

# 3. 维度建模

##### 3.1. 维度表

- 维度表概念
  - 维度表，顾名思义就是一些维度信息，这种表数据，一般就直接存储维度信息，很多时候维度表都不会很大。
  - 维度表，一定是被共享的、通用性的，在数仓系统内一项维度只会有一张维度表；
  - 维度表，轻易不会做变更修改，可以增加、尤其是不要轻易做修改和删除操作；
  - 维度表，会与事实表的维度列做外键关联，使事实表可以生成更多的维度信息；
  - 维度表的属性，是所有查询约束和报表标示的来源；
  - 维度提供数据的入口点，提供所有 DW/BI 分析的最终标识和分组。

- 维度表设计
  - 一般会把维度信息单独存放，其他表要使用时，记录对应维度的id即可。这样，就算维度表中数据发生了变化，其他表数据因为只是记录了id，不会有影响。
  - 维度信息放在一张表中存放，而不是每个表中存储一份，将来需要调整，只需要做一次工作即可，降低了数据冗余。
  - 维度表用于描述环境，多使用单一主键；
  
- 维度分类
  - 退化维度（DegenerateDimension）
    - 退化维度，指的是直接把一些简单的维度放在事实表中；
    - 退化维度是维度建模领域中的一个非常重要的概念，它对理解维度建模有着非常重要的作用，退化维度一般在分析中可以用来做分组使用；
  
  - 缓慢变化维（Slowly Changing Dimensions）
    - 维度的属性并不是始终不变的，它会随着时间的流逝发生缓慢的变化，这种随时间发生变化的维度我们一般称之为缓慢变化维（SCD）；
    - 比如员工表中的部门维度，员工的所在部门有可能两年后调整一次。

  >如果按照范式建模规范，维度建模会存在大量冗余，但这些冗余在维度建模中是必要的的。

##### 3.2. 事实表

- 事实表概念
  - 事实表，就是表述一些事实信息，如订单、收藏,添加购物车等信息，这种数据量较大；
  - 事实表由维度和度量组成，事实表中存储的是维度信息（维度列）、以及可度量的值（属性列）；
    - 比如：区域销售表中，地区是维度，而销售额是度量；
  - 事实表用于存储的是属性的度量；

- 事实表设计
  - 事实表中的维度，一定会对应一张维度表；
  - 事实表一般会有两个或者多个外健，与维度表的主键进行关联；
  - 事实表的主键一般是组合健，表达多对多的关系。
  - 事实表中一般会使用一个代号、或者整数（如：ID）来代表维度成员，而不是描述性的名称；
    - 比如：区域销售统计中，地区一般记录地区ID，而不是地区名称；
  - 因为数据可能会变化，事实表一般存储维度主键，具体维度值在后续处理分析时再临时关联；

- 事实表分类
  - 事务事实表
    - 事务事实表，用于承载事务数据，通常粒度比较低，它是面向事务的，其粒度是每一行对应一个事务，它是最细粒度的事实表，例如产品交易事务事实、ATM交易事务事实；
  - 周期快照事实表
    - 周期快照事实表，按照一定的时间周期间隔(每天，每月)来捕捉业务活动的执行情况，一旦装入事实表就不会再去更新，它是事务事实表的补充。用来记录有规律的、固定时间间隔的业务累计数据，通常粒度比较高，例如账户月平均余额事实表；
  - 周期快照事实表
    - 累积快照事实表，用来记录具有时间跨度的业务处理过程的整个过程的信息，每个生命周期一行，通常这类事实表比较少见。
    
##### 3.3. 星型模型

- 星型模型主要是维表和事实表，以事实表为中心，所有维度直接关联在事实表上，呈星型分布。

  ![]({{site.baseurl}}/img-post/数仓建模方法-3.png)

##### 3.4. 雪花模型

- 雪花模型，维度表的涉及更加规范，一般符合3NF；
- 雪花模型，有效降低数据冗余，维度表之间不会相互关联

##### 3.5. 星型模型 VS 雪花模型

- 星型模型，一般采用降维的操作，反规范化，不符合3NF,利用冗余来避免模型过于复杂，提高易用性和分析效率，效率相对较高；
- 雪花模型，维度表的涉及更加规范，一般符合三范式，有效降低数据冗余，维度表之间不会相互关联；


##### 3.6. 维度建模的常规步骤

- 选择业务过程
  - 业务过程，通常表示的是业务执行的活动，与之相关的维度描述和每个业务过程事件关联的描述性环境；
  - 通常由某个操作型系统支持，例如：订单系统；
  - 业务过程建立或获取关键性能度量；
  - 一系列过程产生一系列事实表；

- 声明粒度
  - 粒度传递的是与事实表度量有关的细节级别；
  - 精确定义某个事实表的每一行表示什么；
  - 对事实表的粒度要达成共识；
  - 粒度是非常重要的，粒度用于确定事实表的行表示什么；

- 确认维度
  - 健壮的维度集合来粉饰事实表；
  - 维度表示承担每个度量环境中所有可能的单值描述符；

- 确认事实
  - 不同粒度的事实必须放在不同的事实表中；
  - 事实表的设计完全依赖物理活动，不受最终报表的影响；
  - 事实表通过外健关联与之相关的维度；
  - 查询操作主要是基于事实表开展计算和聚合。
  
##### 3.7. 维度表的设计

- 主键设计
  - 维度表的唯一主键，应该是代理键，而不是来自系统的标示符，也就是所谓的自然健；
  - 因为自然键通常具有一定的业务含义，但日久天长，这些信息是有可能发生变化的；
  - 而代理健可以提高关联效率并将关系数据库设计和业务的解耦；
  - 维度表和事实表关联的每个连接应该基于无含义的整数代理健；

- 事实表粒度
  - 建议从关注原子级别的粒度数据开始设计，因为原子粒度能够承受无法预估的用户查询；
  - 注意可能的下钻需求，原子数据可以以各种可能的方式进行上卷，而一旦选择了高粒度，则无法满足用户下钻细节的需求；

- 维度退化
  - 固定深度层次在维度表中应该扁平化；
  - 规范化的雪花模型不利于多属性浏览；
  - 而且大量的表和连接操作会影响性能；
  - 非完全独立的维度应该合并为一个维度，将同一层次的元素、标示为事实表中不同的维度是错误的，会增加查询和存储负担，最后变成蜈蚣表；
    - 例如：日维度、周维度、月维度等可以合并为一个周期维度。

- 维度表示例
  - 售前流程的雪花模型：
    - 事实表：客户创建信息表；
    - 维度表：销售信息表、店铺信息表、跟进表/约见表/风控通过表/订单表的维度上卷。
  ![]({{site.baseurl}}/img-post/数仓建模方法-4.png)


# 4. DataVault 模型

DataVault 模型包含三种基本结构 ：
- 中心表-Hub
  - 唯一业务键的列表，唯一标识企业实际业务，企业的业务主体集合
- 链接表-Link
  - 表示中心表之间的关系，通过链接表串联整个企业的业务关联关系
- 卫星表-Satellite
  - 历史的描述性数据，数据仓库中数据的真正载体

![]({{site.baseurl}}/img-post/数仓建模方法-4.png)

- Hub 像人体的骨架，Link 是连接骨架的韧带组织，而 satelite 就是骨架上的血肉；
- DataVault 是对 E-R模型 更近一步的规范化，由于对数据的拆解和更偏向于基础数据组织；
- DataVault 在处理分析类场景时相对复杂，适合数仓低层构建，目前实际应用场景较少。

DataVault 建模流程：
- 梳理所有主要实体；
- 将有入边的实体定义为中心表；
- 将没有入边切仅有一个出边的表定义为中心表；
- 源苦衷没有入边且有两条或以上出边的表定义为连接表；
- 将外键关系定义为链接表；

# 5. Anchor 模型

Anchor 是对 DataVault 模型做了更近一步的规范会处理，初衷是为了设计高度可扩展的模型，核心思想是所有的扩张只添加而不修改，于是设计出的模型基本变成了 k-v 结构的模型，模型范式达到了6NF；
>由于过度规范化，使用中牵涉到太多的 join 操作，因而开发效率和执行性能都是严重挑战。
 



