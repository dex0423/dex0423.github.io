---
layout:     post
title:      数仓部署&运维常用脚本
subtitle:   xsync脚本
date:       2022-01-27
author:     dex0423
header-img: img/post-bg-os-metro.jpg
catalog: true
tags:
    - 数仓
---

# 1. xsync

##### 1.1. xsync 简介

改脚本基于 rsync 而写的，rsync 与 scp 的运行机制不一样，rsync 会对比集群内同目录下是否有不一致，如果有不一样的文件则同步文件过去，如果一致则不更新。

##### 1.2. xsync 脚本

- 在 bin 目录下创建 xsync；
```aidl
cd /bin

vim xsync
```
- 编辑脚本；
```aidl
#!/bin/sh

# 获取输入参数个数，如果没有参数，直接退出
pcount=$#
if((pcount!=4)); then
    echo Usage: $0 filename servername startno endno
    exit;
fi


# 获取文件名称
p1=$1
fname=`basename $p1`
echo fname=$fname

# 获取上级目录到绝对路径
pdir=`cd -P $(dirname $p1); pwd`
echo pdir=$pdir
# 获取当前用户名称
user=`whoami`
# 获取hostname及起止号
slave=$2
startline=$3
endline=$4

# 循环
for((host=$startline; host<=$endline; host++)); do
    echo $pdir/$fname $user@$slave$host:$pdir
    echo ==================$slave$host==================
    rsync -rvl $pdir/$fname $user@$slave$host:$pdir
done
```
- 修改权限
```aidl
chmod 777 xsync
```

##### 1.3. xsync 使用

```aidl
[root@hadoop-1 home]# sudo xsync 1.txt slave 1 2

fname=1.txt
pdir=/home
/home/1.txt root@slave1:/home
==================slave1==================
sending incremental file list
1.txt

sent 90 bytes  received 35 bytes  83.33 bytes/sec
total size is 2  speedup is 0.02
/home/1.txt root@slave2:/home
==================slave2==================
sending incremental file list
1.txt

sent 90 bytes  received 35 bytes  250.00 bytes/sec
total size is 2  speedup is 0.02
```