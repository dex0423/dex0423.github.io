---
layout:     post
title:      数仓建模：数仓建模要注意的问题
subtitle:   
date:       2022-01-27
author:     dex0423
header-img: img/post-bg-os-metro.jpg
catalog: true
tags:
    - 数仓建模
---


# 1. Null 值的使用

##### 1.1. Null 的定义

- NULL 不代表 0，也不代表 0 长度的字符串；

> NULL 的长度不是 0 ！

- 真未知；
- 尚未知；
- 不适用；

##### 1.2. Null 存在的隐患

- 数学计算
  - 任何值和 Null 计算，结果都是 Null；
  - 1 + Null = Null；
  - 1 / Null = Null；
- WEHRE 子句
  - 使用 <>、全选时，Null 值所在的这条记录，会被忽视掉；
- Join
  - Null 和 Null 做 Join 操作的时候，是不会有结果的； 
- 聚合函数
  - Null 在计算的时候，没有参与聚合计算；
  - 若 Null 重设为 0，则 AVG、MIN、MAX、COUNT 都会受到影响；
- 子查询
  - 使用 NOT IN 的时候，会出现错误；
  - 使用 NOT EXISTS，才能保证正常结果；

##### 1.3. 使用 Null 值的原则

- 同一个数据库，对于 Null 值的处理应有统一的原则；
- 数据质量要求不高的，默认值可以为 Null，然后对特殊字段特殊处理；
- 数据质量要求较高的，默认值均为 Not Null，然后特殊字段特殊处理；

![]({{site.baseurl}}/img-post/数仓建模-关系型数据库建模-2.png)

##### 1.4. 范式建模 Null 值使用原则

- 主数据表：
  - CODE 为主键，不可以为空；
    - 未知的值，可以按以下方式赋值：
      - 未知；
      - 不适用；
      - 非法；
      - 未分类；
  - NAME 不可以为空；
    - 默认值可设为空字符串 ''；
- Xref 表：
  - 多字段构成联合主键，不可以为空； 
    - 主要关心的的是多对多关系；
- 事务表：
  - 引用主数据表的字段、设为主键，不可以为空；
  - 为防止聚合计算时出现错误，应充分考虑 Null 值的处理方式，比如增加特殊字段；
  
# 2. 模型灵活性

##### 2.1. 表更新的复杂性

多系统合并、需要多个自然键组合做主键时，尽量不要使用复合键，可以使用 Checksum key，即对多系统的自然键进行 MD5 计算，用 MD5 结果值作为单键主键；

##### 2.2. SQL 语句复杂性

- 当 SQL 需要多表关联的时候，SQL 复杂性会迅速增加。

# 3. 空间占用

- 自然键：
  - 维度表，需要空间比较少；
  - 事实表，通常需要更多空间；
  - 整体来说，需要更多空间；
- 代理键：
  - 维度表，需要更多空间；
  - 事实表，需要更少空间；
  - 整体来说，需要更少空间；

# 4. SQL 语句资源消耗

- 代理键为整型，查询性能较好；
- 自然键如是 VARCHAR，性能比较差；

- 单键的性能较好；
- 复合键的性能差；

- 当数据量达到百万级的时候，性能差异会凸显；

# 5. 数据加载速度

- 自然键：
  - 维度表，直接从源系统过数据，额外开销比较少；
- 代理键：
  - 维度表，代理键插入必须计算最新插入的代理键，需要时间，但和自然键差别不大；

# 6. 数仓分层注意事项

##### 6.1. DW 层设计

DW层如何进行切分，是根据具体的业务需求和公司场景自己去定义，一般来说需要：

1、分层是解决数据流向和快速支撑业务的目的；

2、必须按照主题域和业务域进行贯穿；

3、层级之间不可逆向依赖。

4、如果依赖ODS层数据可以完成数据支撑，那么业务方直接使用落地层这也有利于快速、低成本地进行一些数据方面的探索和尝试。

5、确定分层规范后，后续最好都遵循这个架构，约定成俗即可；

6、血缘关系、数据依赖、数据字典、数据命名规范等配套先行；

##### 6.2. 宽表的误区

在数仓层开始引入了宽表。所谓宽表，迄今为止并没有一个明确的定义。通常做法是把很多的维度、事实上卷或者下钻之后关联到某一个事实表中，形成一张既包含了大量维度又包含了相关事实的表。

宽表的使用，有其一定的便利性。使用方不需要再去考虑跟维度表的关联，也不需要了解维度表和事实表是什么东西。

但是随着业务的增长，我们始终无法预见性地设计和定义宽表究竟该冗余多少维度，也无法清晰地定义出宽表冗余维度的底线在哪里。

一个可能存在的情况是，为了满足使用上的需求，要不断地将维表中已经存在的列增加到宽表中。这直接导致了宽表的表结构频繁发生变动。

目前我们所采用的做法是：

1、根据主题域和业务域，将某个业务的所有节点梳理清楚；

2、将关键节点的数据作为事实表依据，然后横向扩充其他事实表上卷数据（包含一些统计指标），同时纵向的添加该节点上一些主键对应的维度；

3、宽表的涉及不依赖具体的业务需求而是根据整体业务线相匹配；

4、尽量用维度建模代替宽表；

为什么说尽量用维度建模代替宽表，就算字段和数据会冗余，维度建模的方式也会表全量数据的宽表模式较好，原因：

1、维度建模是以某一个既定的事实为依据，既然是事实表，那么这块的业务如果不变动的情况下，事实表的粒度基本不会改变；

2、事实表和维度表解耦，维度表的变更事实表基本不会影响，结果表也只需要回刷一下数据流程即可；

3、新增维度完全可以按照星型模型或者雪花模型动态添加新维度；

4、维度模型可以作为宽表的基础，一旦确定全部的数据流程，可以通过维度模型再生成对应宽表进行快速的业务支撑；

# 7. 指标管理

数仓模型中，最重要的模块可能就是数据治理，我们在建立数仓分层的时候，虽然解决 ETL 任务及工作流的组织、数据的流向、读写权限的控制、不同需求的满足等各类问题，但是在给业务方提供不同数据需求的情况下不可避免的会发生一下几个问题：

1、指标定义不够清晰明确，两个页面上的指标定义其实是不同的，但是展示给商家看到的可能是同一个中文名称。又或者同样一个含义的指标在不同的界面上展示的名称却不相同，让人产生歧义。

2、同一个指标因为由不同的数据开发同学来制作，可能会被重复开发，不但造成资源浪费，还会造成维护困难。

3、对于需要新开发的指标，不仅缺少开发工具简化开发流程，甚至该使用哪些表，不该使用哪些表很大程度上都要凭借数据开发同学与数仓同学的经验。如果稍微马虎一点或者缺乏经验，比如使用了某些业务域下特有的表或者不是由数仓提供的统一中间层的表就可能会使用错误的数据，造成后期返工等情况。

而且在数据需求越来越多，数据中台提供的指标也日益丰富。但是指标定义混乱，描述不清会严重影响数据的可信度和数据开发的成本，所以就需要搭建一个指标系统，来维护已有的数据指标，并为未来可能新增的指标建立相应的规范。

如何去建立好这个指标库或者指标系统呢。

一般来说指标系统主要分为：原子指标和派生指标

1、在数仓分层的时候，进行维度建模，那么就必须指定好相应的主题域和事实表处理的最小逻辑（也就是事实），那么在这个基础上可以先定义原子指标。

原子指标：原子指标和度量含义相同，基于某一业务事件行为下的度量，是业务定义中不可再拆分的指标，具有明确业务含义的名词 ，如支付金额。原子指标描述的其实是一种指标的类型，比如订单支付金额，支付订单数，下单订单数，PV，UV 等等。但是仅仅一个原子指标是不能直接取数的。

但业务方更关心的指标，是有实际业务含义，可以直接取数据的指标。比如店铺近1天订单支付金额就是一个派生指标，会被直接在产品上展示给商家看。这个指标却不能直接从数仓的统一中间层里取数（因为没有现成的事实字段，数仓提供的一般都是大宽表）。需要有一个桥梁连接数仓中间层和业务方的指标需求，于是便有了派生指标。

2、派生指标=维度+原子指标+修饰词。当维度，原子指标，修饰词都确定的时候就可以唯一确定一个派生指标，同时给出具体数值。

例如：店铺近1天订单支付金额中店铺是维度，近1天是一个时间类型的修饰词，支付金额是一个原子指标。

业务方制作每一个派生指标都是通过选择维度，原子指标，修饰词三种元数据来定义的，相对于使用名称来区别不同指标，更可以保证指标的唯一性。如果2个派生指标是不同的，那他们的组成部分一定会有区别，或是不同维度，或是不同原子指标，修饰词。

所以在指标管理的过程中，指标库给予每个指标一个精确且唯一的定义。通过指标库可以快速且规范的查询，开发和使用指标。

指标库主要提供如下服务：

通过设置指标的组成要素来唯一精确定义每个指标（派生指标）。
通过指标在业务域内唯一的性质，解决指标重复定义，重复开发，部分数据对不上的问题。
通过将数仓中间层录入指标库为新制作指标提供指导性的 SQL 或库表推荐。
打通其他各数据平台：
打通数据开发平台和统一数据服务平台，为指标的定义，调度，在线使用提供一条龙服务，简化开发流程。
打通数据资产管理平台，沉淀指标的资产价值。
打通 BI 平台，提供拖拽维度，指标生成报表的功能。

![]({{site.baseurl}}/img-post/dw-layer-2.png)

其中派生指标的生成是通过：业务域+维度+原子指标+修饰词来唯一确定的。

在数仓搭建的时候，业务域、维度、原子指标都是已经明确的，而修饰词是维度的某一些特殊的值，对应 SQL 中的 where 过滤条件。所以如果在数据产品的层面在某个业务域对指标数据定义、生产、使用等过程的流程规范化与平台化，那么就能够从源头上解决上面出现的数据指标不统一、重复开发、指标体系不好维护的问题。