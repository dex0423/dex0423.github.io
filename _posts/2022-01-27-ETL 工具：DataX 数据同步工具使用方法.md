---
layout:     post
title:      ETL 工具：DataX 数据同步工具使用注意事项
subtitle:   
date:       2022-01-27
author:     dex0423
header-img: img/post-bg-os-metro.jpg
catalog: true
tags:
    - 数仓
---

> 关于 DataX 的介绍，请参考 <a href="https://dex0423.github.io/2022/01/27/ETL-ETL%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/">《ETL：ETL的基本概念》</a> 中 ***5.2. DataX*** 一节的内容。

# 1. 环境准备

##### 1.1. python

- 网上文章推荐 python 2.6，但实际 python 3.7 一样支持，自行根据需要选择；
- 注意安装好以后配置环境变量； 
- 安装配置细节，此处不再赘述；

##### 1.2. JDK 

- JDK 需要 1.6 以上，推荐使用 1.6；
- 细节此处不再赘述；

##### 1.3. Apache Maven 

- 安装 Apache Maven 3.x (Compile DataX)；
- 细节此处不再赘述；

# 2. DataX 安装部署

##### 2.1. 安装步骤

- 环境准备

    - python

      服务器自带 Python2 和 Python3，不需要重新安装；

    - JAVA_HOME

        ```
        sudo apt install -y default-jdk
        ```

- 下载安装
    - 在 /home 下新建并进入 work 目录
        ```
        sudo mkdir /home/work & cd /home/work
        ```

    - 下载解压 datax
        ```
        wget http://datax-opensource.oss-cn-hangzhou.aliyuncs.com/datax.tar.gz
        tar -zxvf datax.tar.gz
        
        ```
    - 下载解压 data-web
        - 百度网盘：https://pan.baidu.com/s/13yoqhGpD00I82K4lOYtQhg，密码：cpsk；
        - 手动上传到 /home/work 目录中，并解压缩；
            ```
            tar -zxvf datax-web-2.1.2.tar.gz
            ```
- 安装 & 初始化

    ```
    cd /home/work/datax-web-2.1.2/bin
    ./install.sh
    
    ...
    Do you want to initalize database with sql: [/home/work/datax-web/build/datax-web-2.1.2/bin/db/datax_web.sql]? (Y/N)y
    Please input the db host(default: 127.0.0.1): 
    Please input the db port(default: 3306): 
    Please input the db username(default: root): jianzi
    Please input the db password(default: ): 4ylnkL6lRT
    Please input the db name(default: dataxweb)
    ...
  ```

##### 2.2. 修改 DB 配置

- 修改 datax 服务器本地 MySQL 数据库，用于存储 datax 账号密码、同步任务、数据源连接信息等；

    ```
    vim /home/work/datax-web/build/datax-web-2.1.2/modules/datax-admin/conf/bootstrap.properties
    
    #Database
    DB_HOST=xxx.xxx.xxx.xxx
    DB_PORT=3306
    DB_USERNAME=xxx
    DB_PASSWORD=xxx
    DB_DATABASE=dataxweb
    ```

##### 2.3. 初始化

- 初始化操作时，会重新在 MySQL 中新建用户和任务信息，如果是重新初始化，记得将 MySQL dataxweb 库中的数据做备份。

    ```
    cd /home/work/datax-web/build/datax-web-2.1.2/bin & ./install.sh
    
    ...
    Do you want to initalize database with sql: [/home/work/datax-web/build/datax-web-2.1.2/bin/db/datax_web.sql]? (Y/N)y
    Please input the db host(default: 127.0.0.1): 
    Please input the db port(default: 3306): 
    Please input the db username(default: root): xxxx
    Please input the db password(default: ): xxxx
    Please input the db name(default: dataxweb)
    ...
    ```

##### 2.4. 添加 MySQL8 需要的 jar 包

- mysql-connector-java-8.0.28.jar 文件下载地址
  
    - <a href="{{site.baseurl}}/files/mysql-connector-java-8.0.28.jar">点击下载站内资源：mysql-connector-java-8.0.28.jar</a>

- 查找文件 mysql-connector-java-5.1.47.jar 所在位置
    ```
    find -name "*mysql-con*"
    ```

- 下面返回的是文件路径示例，这些目录全部都要进行添加
    ```
    /home/work/datax-web-2.1.2/modules/datax-admin/lib/mysql-connector-java-5.1.47.jar
    /home/work/datax/plugin/writer/drdswriter/libs/mysql-connector-java-5.1.34.jar
    /home/work/datax/plugin/writer/drdswriter/libs/._mysql-connector-java-5.1.34.jar
    /home/work/datax/plugin/writer/mysqlwriter/libs/mysql-connector-java-5.1.34.jar
    /home/work/datax/plugin/writer/mysqlwriter/libs/._mysql-connector-java-5.1.34.jar
    /home/work/datax/plugin/writer/adswriter/libs/._mysql-connector-java-5.1.31.jar
    /home/work/datax/plugin/writer/adswriter/libs/mysql-connector-java-5.1.31.jar
    /home/work/datax/plugin/reader/drdsreader/libs/mysql-connector-java-5.1.34.jar
    /home/work/datax/plugin/reader/drdsreader/libs/._mysql-connector-java-5.1.34.jar
    /home/work/datax/plugin/reader/oceanbasev10reader/libs/mysql-connector-java-5.1.40.jar
    /home/work/datax/plugin/reader/mysqlreader/libs/mysql-connector-java-5.1.34.jar
    /home/work/datax/plugin/reader/mysqlreader/libs/._mysql-connector-java-5.1.34.jar
    ```
- 将 mysql-connector-java-8.0.28.jar 文件放到上面返回的文件所在目录


# 3. DataX 使用

##### 3.1. DataX 启动命令

- 在启动前，记得先执行关闭操作；
  
    ```
    cd /home/work/datax-web/build/datax-web-2.1.2/bin
    bash stop-all.sh
    ./start-all.sh
    ```

##### 3.2. 访问 datax-web

- 访问地址：http://xxx.xxx.xxx.xxx:9527/index.html

- 访问datax-web 记住务必加/index.html，不加会提示 `Whitelabel Error Page` 报错！

##### 3.3. DataX 用户管理

- 注意：首次启动，一定要修改 admin 密码！

    修改路径： `用户管理 > admin > 编辑 > 密码`


##### 3.4. MySQL8 修改 jdbc 驱动类

- EDS 如果连接 MySQL8，数据源连接需要修改 jdbc 驱动类

  jdbc 驱动类：
    
    ```
    com.mysql.cj.jdbc.Driver
    ```

# 4. DataX 任务管理

##### 4.1. DataX 任务模板

- 阻塞处理
  
    - 选择：**单机串行**；

      ![]({{site.baseurl}}/img-post/datax-2.png)
  

##### 4.2. 创建任务：reader 增量同步

- 增量同步 where 条件：

  更新指定时间内的数据。

  ```
  "where": "last_update_time>=subdate(current_date, 1)",    # 更新昨天的数据
  
  "where": "last_update_time>=subdate(current_date, 7)",    # 更新七天内的数据
  ```

#####  4.3. 创建任务：writer 替换更新

- 写入模式使用 replace；
    
  replace 在写入数据的时候，会对主键相同的数据进行 update，而不是 insert。
  
  ```
  "writeMode": "replace",
  ```
  
##### 4.4. 切分字段

- 如果要同步的数据量比较大，需要在创建任务的时候，添加主键作为切分字段。
  
  ```
  "splitPk": "sales_order_id"
  ```

##### 4.5. 任务示例

```
{
  "job": {
    "setting": {
      "speed": {
        "channel": 3,
        "byte": 1048576
      },
      "errorLimit": {
        "record": 0,
        "percentage": 0.02
      }
    },
    "content": [
      {
        "reader": {
          "name": "mysqlreader",
          "parameter": {
            "where": "last_update_time>=subdate(current_date, 7)",
            "username": "xxxxx",
            "password": "xxxxx",
            "column": [
              "`add_time`",
              "`last_update_time`",
              "`日期`",
              "`店铺_系统或分销商`",
              "`规格编码`",
              "`发货数量`",
              "`退货数量`",
              "`销售数量`",
              "`发货金额`",
              "`退货金额`",
              "`实际销售额`",
              "`数据来源表`",
              "`发退货类型`"
            ],
            "splitPk": "xxx_id",
            "connection": [
              {
                "table": [
                  "xxxxxx"
                ],
                "jdbcUrl": [
                  "jdbc:mysql://xxx.xxx.xxx.xxx:3306/xxx"
                ]
              }
            ]
          }
        },
        "writer": {
          "name": "mysqlwriter",
          "parameter": {
            "writeMode": "replace",
            "username": "xxxxx",
            "password": "xxxxx",
            "column": [
              "`source_add_time`",
              "`source_last_update_time`",
              "`日期`",
              "`店铺_系统或分销商`",
              "`规格编码`",
              "`发货数量`",
              "`退货数量`",
              "`销售数量`",
              "`发货金额`",
              "`退货金额`",
              "`实际销售额`",
              "`数据来源表`",
              "`发退货类型`"
            ],
            "connection": [
              {
                "table": [
                  "ods_xxxxxx"
                ],
                "jdbcUrl": "jdbc:mysql://xxx.xxx.xxx.xxx:3306/ods"
              }
            ]
          }
        }
      }
    ]
  }
}
```


# 5. DataX 异常处理

##### 5.1. 无法访问 datax-web

- 问题现象：
    - 启动无报错，但无法访问 datax-web 网页

- 处理方法：重新安装初始化 datax

    ```
    cd /home/work/datax-web/build/datax-web-2.1.2/bin & ./install.sh
    ```

##### 5.2. 初始化 datax 时 MySQL 拒绝访问

- 报错内容：

  `ERROR 1045 (28000): Access denied for user 'root'@'xxx.xxx.xxx.xxx' (using password: YES)`

- 处理方法：不要使用 root 账号连接 MySQL，使用 jianzi 账号密码连接 MySQL

    ```
    Please input the db username(default: root): jianzi
    Please input the db password(default: ): 4ylnkL6lRT
    ```

##### 5.3. 启动 DataX 不成功

- 报错内容：
  
  `DATAX-EXEXUTOR didn't start successfully, not found in the java process table`

- 处理方法：
    ```
    ./start-all.sh start -v
    ```

##### 5.4. 无法连接数据源

- 报错内容：
  
  `Code:[DBUtilErrorCode-10], Description:[连接数据库失败. 请检查您的 账号、密码、数据库名称、IP、Port或者向 DBA 寻求帮助(注意网络环境).]. - 具体错误信息为：com.mysql.jdbc.exceptions.jdbc4.MySQLNonTransientConnectionException: Could not create connection to database server.`

- 处理方法：

    - 检查要连接的 MySQL 账号密码；
    - 检查要连接的 MySQL 服务器端口是否开放；
    - 检查要连接的 MySQL 版本，如果是 MySQL8，修改 jdbc 驱动类：
      ```
      com.mysql.cj.jdbc.Driver
      ```

##### 5.5. datax-web 创建任务报错

  - 报错内容：

    `### Error querying database. Cause: com.mysql.jdbc.exceptions.jdbc4.MySQLSyntaxErrorException: Unknown column 't.user_id' in 'field list' ### The error may exist in file [/home/work/datax-web/build/datax-web-2.1.2/modules/datax-admin/conf/mybatis-mapper/JobInfoMapper.xml] ### The error may involve com.wugui.datax.admin.mapper.JobInfoMapper.findAll-Inline ### The error occurred while setting parameters ### SQL: SELECT t.id, t.job_group, t.job_cron, t.job_desc, t.add_time, t.update_time, t.user_id, t.alarm_email, t.executor_route_strategy, t.executor_handler, t.executor_param, t.executor_block_strategy, t.executor_timeout, t.executor_fail_retry_count, t.glue_type, t.glue_source, t.glue_remark, t.glue_updatetime, t.child_jobid, t.trigger_status, t.trigger_last_time, t.trigger_next_time, t.job_json, t.replace_param, t.jvm_param, t.inc_start_time, t.partition_info, t.last_handle_code, t.replace_param_type, t.project_id, t.reader_table, t.primary_key, t.inc_start_id, t.increment_type, t.datasource_id FROM job_info AS t ORDER BY job_desc ASC ### Cause: com.mysql.jdbc.exceptions.jdbc4.MySQLSyntaxErrorException: Unknown column 't.user_id' in 'field list' ; bad SQL grammar []; nested exception is com.mysql.jdbc.exceptions.jdbc4.MySQLSyntaxErrorException: Unknown column 't.user_id' in 'field list'`

    ![]({{site.baseurl}}/img-post/datax-1.png)

    其中的关键错误是：`Unknown column 't.user_id' in 'field list' `。

  - 处理方法：

    连接 dataX 服务器上 MySQL，进入 `dataxweb > jobinfo`，修改 `author(VARCHAR(50))` 字段名为 `user_id(INT(11))`；

    修改后重新创建任务；

    注意：这是个临时解决方案，详细原因并未知晓！！！

##### 5.6. 调度失败

- 报错内容：

    ```
    任务触发类型：手动触发
    调度机器：172.16.0.157
    执行器-注册方式：自动注册
    执行器-地址列表：null
    路由策略：随机
    阻塞处理策略：单机串行
    任务超时时间：0
    失败重试次数：0
    
    >>>>>>>>>>>触发调度<<<<<<<<<<<
    调度失败：执行器地址为空
    ```
- 处理方法：

    - 十分钟后再次执行任务。
    
##### 5.7. `can't find '__main__' module in ''`

- 报错内容：

    ```
    2022-04-20 20:18:57 [JobThread.run-130] <br>----------- datax-web job execute start -----------<br>----------- Param:
    2022-04-20 20:18:57 [BuildCommand.buildDataXParam-100] ------------------Command parameters:
    2022-04-20 20:18:57 [ExecutorJobHandler.execute-57] ------------------DataX process id: -1
    2022-04-20 20:18:57 [ProcessCallbackThread.callbackLog-186] <br>----------- datax-web job callback finish.
    2022-04-20 20:18:57 [AnalysisStatistics.analysisStatisticsLog-53] /usr/bin/python: can't find '__main__' module in ''
    2022-04-20 20:18:57 [JobThread.run-165] <br>----------- datax-web job execute end(finish) -----------<br>----------- ReturnT:ReturnT [code=500, msg=command exit value(1) is failed, content=null]
    2022-04-20 20:18:57 [TriggerCallbackThread.callbackLog-186] <br>----------- datax-web job callback finish.
    ```

- 处理方法：

    - 原因分析：datax-web找不到datax启动文件（datax.py）

    - 修改 datax-executor.sh 文件

        ```
        cd /home/work/datax-web/modules/datax-executor/bin
        vim datax-executor.sh
        ```
      找到下面的代码并注释掉。
        ```
        # JAVA_OPTS=${JAVA_OPTS}" -Dserver.port="${SERVER_PORT}" -Ddata.path="${DATA_PATH}" -Dexecutor.port="${EXECUTOR_PORT}" -Djson.path="${JSON_PATH}" -Dpython.path="${PYTHON_PATH}" -Ddatax.admin.port="${DATAX_ADMIN_PORT}
        ```
      写入成下面的代码。
        ```
        JAVA_OPTS=${JAVA_OPTS}" -Dserver.port="${SERVER_PORT}" -Ddata.path="${DATA_PATH}" -Dexecutor.port="${EXECUTOR_PORT}" -Djson.path="${JSON_PATH}" -Dpython.path="/home/work/datax/bin/datax.py" -Ddatax.admin.port="${DATAX_ADMIN_PORT}
        ```
    - 保存退出，重启 datax-web。
    
##### 5.8. `您提供的配置文件存在错误信息，请检查您的作业配置。`

- 报错内容：
  
    `
    插件[odpsreader,mysqlwriter]加载失败，1s后重试... Exception:Code:[Common-00], Describe:[您提供的配置文件存在错误信息，请检查您的作业配置 .] - 配置信息错误，
    您提供的配置文件[/home/work/datax/plugin/reader/._hbase11xreader/plugin.json]不存在. 请检查您的配置文件.
    经DataX智能分析,该任务最可能的错误原因是:
    com.alibaba.datax.common.exception.DataXException: Code:[Common-00], Description:[您提供的配置文件存在错误信息，请检查您的作业配置。].
     -配置信息错误 ,您提供的配置文件:/home/work/datax/plugin/reader/._hbase11xreader/plugin.json]不存在，请检查您的配置文件。
    `
- 处理方法：

    - 原因分析：操作过 reader 目录的内容，系统会自动生成一个.DS_Store 的系统文件，dataX默认plugin/render都是文件夹，没有做操作系统这种层面的差异处理所以需要手动把错误路径下的._hbase11xreader文件删除即可。
    
    - 处理方法：
    
        ```
        find . -name '._*'|xargs rm -rf
        ```
      
